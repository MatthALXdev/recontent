name: CI/CD ReContent

on:
  pull_request:
    branches: [develop, main]
  push:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # JOB 1: Tests API Backend
  # ============================================
  test-api:
    name: API Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install dependencies
        working-directory: ./api
        run: npm ci

      - name: Run tests
        working-directory: ./api
        run: npm test
        env:
          MISTRAL_API_KEY: test-key-mock

      - name: Generate coverage
        working-directory: ./api
        run: npm run test -- --coverage
        env:
          MISTRAL_API_KEY: test-key-mock

  # ============================================
  # JOB 2: Tests Frontend React
  # ============================================
  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run tests
        working-directory: ./frontend
        run: npm test

      - name: Generate coverage
        working-directory: ./frontend
        run: npm run test -- --coverage

  # ============================================
  # JOB 3: Build Validation
  # ============================================
  build-validation:
    name: Build Validation
    runs-on: ubuntu-latest
    needs: [test-api, test-frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Verify build output
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "âŒ Build failed: dist folder not found"
            exit 1
          fi
          if [ ! -f "frontend/dist/index.html" ]; then
            echo "âŒ Build failed: index.html not found"
            exit 1
          fi
          echo "âœ… Build successful"
          ls -la frontend/dist/

  # ============================================
  # JOB 4: Integration Test (PR vers main only)
  # ============================================
  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [build-validation]
    if: github.base_ref == 'main'

    steps:
      - name: Checkout ReContent
        uses: actions/checkout@v4
        with:
          path: recontent

      - name: Checkout Infra
        uses: actions/checkout@v4
        with:
          repository: MatthALXdev/devamalix-infra
          ref: main
          path: shared
          token: ${{ secrets.INFRA_PAT }}

      - name: Create traefik network
        run: docker network create traefik-network || true

      - name: Start Traefik
        working-directory: shared/traefik
        run: |
          docker compose -f docker-compose.ci.yml up -d
          sleep 5
          docker ps | grep traefik

      - name: Build and start ReContent
        working-directory: recontent
        run: |
          # Create dist directory to ensure proper volume mounting
          mkdir -p frontend/dist
          # Build frontend
          docker compose run --rm recontent-frontend

          # Verify build output exists
          echo "ğŸ“¦ Verifying build output..."
          ls -la frontend/dist/
          if [ ! -f "frontend/dist/index.html" ]; then
            echo "âŒ Build failed: index.html not found in dist/"
            exit 1
          fi
          echo "âœ… Build artifacts present"

          # Start services
          docker compose up -d recontent-api nginx-recontent
          sleep 20

      - name: Test Docker network
        run: |
          docker network inspect traefik-network \
            | grep -q "recontent-nginx" \
            || (echo "âŒ nginx-recontent not on traefik-network" && exit 1)
          echo "âœ… nginx-recontent is on traefik-network"

      - name: Wait for Traefik to register routes
        run: |
          echo "â³ Waiting for Traefik to register ReContent routes..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/api/http/routers | grep -q "recontent"; then
              echo "âœ… ReContent router registered in Traefik (attempt $i)"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ Timeout: ReContent router not registered after 30s"
              echo "Available routers:"
              curl -s http://localhost:8080/api/http/routers || true
              exit 1
            fi
            echo "Waiting... (attempt $i/30)"
            sleep 1
          done

      - name: Test routing via Traefik
        run: |
          # Test Frontend
          curl -f http://localhost/recontent/ \
            -H "Host: recontent.nexus.local" \
            || (echo "âŒ Frontend routing failed" && exit 1)
          echo "âœ… Frontend accessible via Traefik"

          # Test API
          curl -f http://localhost/api/recontent/health \
            -H "Host: recontent.nexus.local" \
            || (echo "âŒ API routing failed" && exit 1)
          echo "âœ… API accessible via Traefik"

      - name: Verify Traefik registration
        run: |
          curl -s http://localhost:8080/api/http/routers \
            | grep -q "recontent" \
            || (echo "âŒ ReContent router not registered" && exit 1)
          echo "âœ… ReContent router registered in Traefik"

      - name: Test no direct port exposure
        run: |
          ! curl -f http://localhost:3002/health --max-time 2 2>/dev/null \
            && echo "âœ… Port 3002 not exposed (as expected)" \
            || (echo "âŒ Port 3002 exposed directly" && exit 1)

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Traefik logs ==="
          docker logs traefik 2>&1 | tail -50 || true
          echo ""
          echo "=== ReContent API logs ==="
          docker logs recontent-api 2>&1 | tail -50 || true
          echo ""
          echo "=== Nginx ReContent logs ==="
          docker logs recontent-nginx 2>&1 | tail -50 || true

      - name: Cleanup
        if: always()
        run: |
          docker compose -f recontent/docker-compose.yml down -v || true
          docker compose -f shared/traefik/docker-compose.ci.yml down -v || true
          docker network rm traefik-network || true

  # ============================================
  # JOB 5: Deploy to VPS (push main only)
  # ============================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [test-api, test-frontend, build-validation]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."
            cd ~/recontent

            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin main

            echo "ğŸ”„ Rebuilding containers..."
            docker compose down
            docker compose up -d --build

            echo "â³ Waiting for services to start..."
            sleep 30

            echo "ğŸ” Running smoke test..."
            curl -f https://recontent.devamalix.fr/api/recontent/health \
              || (echo "âŒ Deploy failed - smoke test failed" && exit 1)

            echo "âœ… Deployment successful!"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Check logs above."
          echo "Manual rollback may be required on VPS."
