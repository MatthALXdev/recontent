# ReContent.dev - React + Node.js + Nginx
# Application de repurposing de contenu avec Mistral AI

networks:
  # Network interne pour API <-> Nginx
  recontent-network:
    driver: bridge
    name: recontent-network

  # Network Traefik externe (doit déjà exister)
  traefik-network:
    external: true
    name: traefik-network

services:
  # Frontend React/Vite (build uniquement)
  recontent-frontend:
    image: node:20-alpine
    container_name: recontent-frontend
    working_dir: /app
    volumes:
      - ./frontend:/app
      - ./frontend/dist:/app/dist
    command: sh -c "npm install --include=dev && npm run build"
    environment:
      - NODE_ENV=development
    networks:
      - recontent-network

  # API Node.js (Express + proxy Mistral)
  recontent-api:
    image: node:20-alpine
    container_name: recontent-api
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./api:/app
    # Port NON exposé - accessible uniquement via nginx interne
    # ports:
    #   - "3002:3002"
    environment:
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      - API_PORT=${API_PORT:-3002}
      - NODE_ENV=${NODE_ENV:-production}
      - TZ=${TZ:-Europe/Paris}
    command: sh -c "npm install && npm start"
    networks:
      - recontent-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3002/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Nginx - Reverse Proxy + Frontend statique
  nginx-recontent:
    image: nginx:alpine
    container_name: recontent-nginx
    restart: unless-stopped
    # Port NON exposé - accessible uniquement via Traefik
    # ports:
    #   - "8090:80"
    volumes:
      - ./nginx/recontent.conf:/etc/nginx/conf.d/recontent.conf:ro
      - ./nginx/entrypoint.sh:/docker-entrypoint-custom.sh:ro
      - ./frontend/dist:/usr/share/nginx/html/recontent:ro
    entrypoint: ["/docker-entrypoint-custom.sh"]
    depends_on:
      - recontent-api
    networks:
      - recontent-network
      - traefik-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1/recontent/"]
      interval: 30s
      timeout: 5s
      retries: 3

    # Labels Traefik pour routage via recontent.nexus.local
    labels:
      # Activation Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-network"

      # Router HTTP (pas HTTPS en local)
      - "traefik.http.routers.recontent.rule=Host(`recontent.nexus.local`)"
      - "traefik.http.routers.recontent.entrypoints=web"
      - "traefik.http.routers.recontent.service=recontent"

      # Service (port interne nginx)
      - "traefik.http.services.recontent.loadbalancer.server.port=80"

      # Watchtower auto-update
      - "com.centurylinklabs.watchtower.enable=true"
