version: '3.8'

# ReContent.dev - React + Node.js + Nginx
# Projet NEXUS - Environnement DEV/WEB

networks:
  recontent-network:
    driver: bridge
    name: nexus-recontent

services:
  # Frontend React/Vite (build uniquement)
  recontent-frontend:
    image: node:20-alpine
    container_name: nexus-recontent-frontend
    working_dir: /app
    volumes:
      - ./frontend:/app
      - ./frontend/dist:/app/dist
    command: sh -c "npm install --include=dev && npm run build"
    environment:
      - NODE_ENV=development
    networks:
      - recontent-network

  # API Node.js (Express + proxy Mistral)
  recontent-api:
    image: node:20-alpine
    container_name: nexus-recontent-api
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./api:/app
    ports:
      - "3002:3002"
    environment:
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      - API_PORT=${API_PORT:-3002}
      - NODE_ENV=${NODE_ENV:-production}
      - TZ=${TZ:-Europe/Paris}
    command: sh -c "npm install && npm start"
    networks:
      - recontent-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Nginx - Reverse Proxy + Frontend statique
  nginx-recontent:
    image: nginx:alpine
    container_name: nexus-nginx-recontent
    restart: unless-stopped
    ports:
      - "8090:80"
    volumes:
      - ./nginx/recontent.conf:/etc/nginx/conf.d/recontent.conf:ro
      - ./nginx/entrypoint.sh:/docker-entrypoint-custom.sh:ro
      - ./frontend/dist:/usr/share/nginx/html/recontent:ro
      - ../../shared/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    entrypoint: ["/docker-entrypoint-custom.sh"]
    depends_on:
      - recontent-api
    networks:
      - recontent-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/recontent/"]
      interval: 30s
      timeout: 5s
      retries: 3
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
